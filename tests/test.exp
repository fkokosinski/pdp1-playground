set timeout 1

proc run_test { demo_name expected_output } {
	spawn "pdp1"
	send "attach ptr $demo_name/main.rim\n"
	expect {
		"PTR: creating new file"	{ fail "Didn't find the RIM tape file\n" }
		"sim>"				{ pass "Successfully loaded the RIM tape file\n" }
		default				{ fail "Test failed unexpectedly\n" }
	}
	
	send "boot ptr\n"
	expect {
		"$expected_output"		{ pass "Encountered expected output\n" }
		default				{ fail "Didn't encounter expected output\n" }
	}
	expect {
		-re "HALT instruction,.*"	{ pass "Program finished running normally\n" }
		default				{ fail "Program halted unexpectedly\n" }
	}

	send "quit\n"
}

run_test "asm-print-x" "x"
run_test "asm-hello-world" "hello, world"
run_test "c-print-x" "xx"
run_test "c-print-struct" "xyz"
run_test "c-print-array" "xyzxyzxyzxyz"
run_test "c-print-for-loop" "xxxxyxxx"
run_test "c-test-comparison" "aceg"
